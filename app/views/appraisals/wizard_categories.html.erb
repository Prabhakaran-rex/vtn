<%= stylesheet_link_tag 'chosen.css' %>
<div class="row">
  <h4>Step 3 - Select Categories</h4>
</div>
<div class="container">
  <div class="row sub_box">
    <h3>Please assign one category to the item</h3>

    <select data-placeholder="Choose a category..." style="width:350px;" class="chzn-select" id="demo6">
      <option></option>
      <% Category.order(:name).each do |c| %>
        <option value="<%= c.id %>"><%= c.name %></option>	
    <% end %>
    </select>

    <div id="divCategoriesSelect" <%= "style=display:none;" if !@appraisal.classification.nil? %>>
      <input type="hidden" name="demo6" />
      <button class="btn btn-success btn-mini" id='addClassificationBtn'>Add</button>
    </div>
    <div class="results" id="demo6-result"></div>
    <div>
      <table class="table" id="classificationTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        <% unless @appraisal.classification.nil? %>
          <tr>
          <td><%= @appraisal.classification.category.name  %></td>
          <td><button class="btn btn-danger btn-mini" onClick="deleteCategory($(this),'<%= "#{@appraisal.classification.id}" %>')">Remove</button></td>
        </tr>
      <% end %>
        </tbody>
      </table>
    </div>
    <div class="form-actions">
      <% if @appraisal.status == EActivityValueCreated && !params[:pay] %>
        <% @payment = Payment.new %>
      <%= link_to 'Next step', payments_path(@payment, :appraisal_id => @appraisal), :class => "btn btn-success pull-right", :id => "btn_next_step"%>
    <% end %>
    </div>
  </div>
</div>
<script type="text/javascript">
/* Delete Task */
function deleteCategory(caller, id ) {
  $.ajax({
    url: "<%= url_for classifications_path %>/" + id+'.json',
    type: 'post',
    dataType: 'script',
    data: { '_method': 'delete' },
    success: function() {
      $(caller).closest('tr').remove();
      $('#divCategoriesSelect').show();
    }
  });
}

$(function() {
  $("#addClassificationBtn").click(function() {
    $.post('<%= url_for classifications_path %>.json',{ 'classification[appraisal_id]': '<%= @appraisal.id %>', 'classification[category_id]': $('#demo6').val() },function(data) {
      var category = $('#demo6 option:selected').text();
      var subcategory = $('#demo6 option:selected').text();
      $('#classificationTable > tbody:last').append('<tr><td>'+category +'</td><td>'+'<button class="btn btn-danger btn-mini" onClick="deleteCategory($(this),'+data.id+')">Remove</button>'
                                                    +'</td></tr>');

      $('#divCategoriesSelect').hide();
    } );
  });

  $("#btn_next_step").click(function() {
    if ($("#classificationTable > tbody > tr").length === 0 ) {
      alert("Error. Please choose a category before proceeding");
      return false;
    }
  });
});
</script>
<%= javascript_include_tag "chosen.jquery.min.js" %>
<script type="text/javascript"> $(".chzn-select").chosen(); $(".chzn-select-deselect").chosen({allow_single_deselect:true}); </script>
